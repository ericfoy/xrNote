<?php
// Later we'll implement lazy loading...
// XRNote dev includes (eager load).
require_once __DIR__ . '/includes/xrnote.anchor.inc';
require_once __DIR__ . '/includes/xrnote.render.inc';
//require_once __DIR__ . '/includes/xrnote.pages.inc';   // modal + AJAX handlers
//require_once __DIR__ . '/xrnote.theme.inc';            // theme functions (if any)

/*
Caution: The function should not be used in a global context (e.g., at the very 
top of your .module file, outside of any functions), as it requires Backdrop to be 
fully bootstrapped first. In a global context, you should use require_once with the 
full path if absolutely necessary. 

module_load_include('inc', 'xrnote', 'includes/xrnote.anchor');
module_load_include('inc', 'xrnote', 'includes/xrnote.render');
*/

function xrnote_permission() {
  return array(
    'create xrnotes' => array('title'=>'Create XR notes'),
    'edit own xrnotes' => array('title'=>'Edit own XR notes'),
    'edit any xrnotes' => array('title'=>'Edit any XR notes'),
    'place xrnotes' => array('title'=>'Insert XR notes into documents'),
    'configure xrnote display' => array('title'=>'Configure XRNote display modes'),
  );
}

function xrnote_menu() {
  $items['xrnote/modal/add/%node/%'] = array(
    'page callback'   => 'xrnote_modal_add',
    'page arguments'  => array(3, 4),
    'access callback' => 'xrnote_access_place',
    'access arguments'=> array(3),
    'type'            => MENU_CALLBACK,
  );

  $items['xrnote/modal/edit/%node/%'] = array(
    'page callback'   => 'xrnote_modal_edit',
    'page arguments'  => array(3, 4),
    'access callback' => 'xrnote_access_place',
    'access arguments'=> array(3),
    'type'            => MENU_CALLBACK,
  );

  $items['xrnote/anchors/%node'] = array(
    'page callback'   => 'xrnote_ajax_sidebar',
    'page arguments'  => array(2),
    'access callback' => 'xrnote_access_place',
    'access arguments'=> array(2),
    'type'            => MENU_CALLBACK,
  );

  return $items;
}

function xrnote_access_place($node) {
  return user_access('place xrnotes') && node_access('update', $node);
}

/**
 * Attach TinyMCE plugin and the live sidebar on node edit of target types.
 * Replace 'xrnote' with your actual content type that has "Main Text".
 */
function xrnote_form_alter(&$form, &$form_state, $form_id) {
  if (($form_id !== 'node_form' && strpos($form_id, '_node_form') === FALSE) || !isset($form['#node'])) {
    return;
  }

  $node = $form['#node'];
  if (!xrnote_is_document_node($node)) {
    return;
  }

  $wrap_open  = '<div class="xrnote-editor-wrap"><div class="xrnote-editor-main">';
  $wrap_close = '</div><div id="xrnote-sidebar" class="xrnote-sidebar"></div></div>';

  if (isset($form['body'])) {
    $form['body']['#prefix'] = ($form['body']['#prefix'] ?? '') . $wrap_open;
    $form['body']['#suffix'] = $wrap_close . ($form['body']['#suffix'] ?? '');
}

  $form['#attached']['library'][] = array('system', 'backdrop.ajax');
  $form['#attached']['library'][] = array('system', 'backdrop.dialog.ajax');

  $form['#attached']['js'][]  = backdrop_get_path('module', 'xrnote') . '/js/xrnote.sidebar.js';
  $form['#attached']['css'][] = backdrop_get_path('module', 'xrnote') . '/css/xrnote.admin.css';

  $form['#attached']['js'][] = array(
    'type' => 'setting',
    'data' => array(
      'xrnote' => array(
        'nid' => (int) $node->nid,
        'basePath' => base_path(),
      ),
    ),
  );
}

function xrnote_node_update($node) {
  if (!xrnote_is_document_node($node)) return;
  xrnote_reanchor_node($node);
}

function xrnote_node_view($node, $view_mode, $langcode) {
  if (!xrnote_is_document_node($node)) return;
  $lang = field_language('node', $node, 'body');
  if (!empty($node->content['body'][$lang][0]['#markup'])) {
    $html = $node->content['body'][$lang][0]['#markup'];
    $node->content['body'][$lang][0]['#markup'] = xrnote_inline_replace($html);
  }
}

function xrnote_modal_add($parent_node, $uuid) {
  return backdrop_get_form('xrnote_modal_add_form', $parent_node, $uuid);
}

function xrnote_modal_add_form($form, &$form_state, $parent_node, $uuid) {
  $form['#prefix'] = '<div id="xrnote-modal-add-wrapper">';
  $form['#suffix'] = '</div>';

  // Hidden fields so values are definitely present on /system/ajax POST.
  $form['parent_nid'] = array(
    '#type' => 'hidden',
    '#value' => (int) $parent_node->nid,
  );

  $form['xr_uuid'] = array(
    '#type' => 'hidden',
    '#value' => (string) $uuid,
  );

  $form['note_nid'] = array(
    '#type' => 'entity_autocomplete',
    '#title' => t('Select existing XRNote'),
    '#target_type' => 'node',
    '#selection_settings' => array('target_bundles' => array('xrnote' => 'xrnote')),
    '#required' => FALSE,
  );

  $form['new_body'] = array(
    '#type' => 'textarea',
    '#title' => t('Or create new'),
    '#rows' => 6,
    '#required' => FALSE,
  );

  $form['actions'] = array('#type' => 'actions');
  $form['actions']['insert'] = array(
    '#type' => 'submit',
    '#value' => t('Insert'),
    '#submit' => array('xrnote_modal_add_form_submit'),
  /* optional validation limiters:
    '#limit_validation_errors' => array(
      array('note_nid'),
      array('new_body'),
      array('xr_uuid'),
      array('parent_nid'),
    ),
  */
    '#ajax' => array(
      'callback' => 'xrnote_modal_add_form_ajax',
    ),
  );

  return $form;
}

function xrnote_modal_add_form_submit($form, &$form_state) {
  // Parse entity_autocomplete value safely (can be "Title (123)" or just "123").
  $raw = isset($form_state['values']['note_nid']) ? $form_state['values']['note_nid'] : '';
  $nid = 0;
  if (is_numeric($raw)) {
    $nid = (int) $raw;
  }
  elseif (is_string($raw) && preg_match('/\((\d+)\)\s*$/', $raw, $m)) {
    $nid = (int) $m[1];
  }

  // If no existing note selected, create one from new_body.
  if (!$nid) {
    $body = trim((string) ($form_state['values']['new_body'] ?? ''));
    if ($body !== '') {
      $n = entity_create('node', array(
        'type'     => 'xrnote',
        'title'    => 'XRNote ' . REQUEST_TIME,
        'status'   => 1,
        'langcode' => LANGUAGE_NONE,
      ));
      $lang = LANGUAGE_NONE;
      $n->field_xr_body[$lang][0]['value'] = $body;
      $n->save();
      $nid = !empty($n->nid) ? (int) $n->nid : 0;
    }
  }

  $form_state['xrnote_note_nid'] = $nid;
}

function xrnote_modal_add_form_ajax($form, &$form_state) {
  $uuid = !empty($form_state['values']['xr_uuid']) ? (string) $form_state['values']['xr_uuid'] : '';
  $nid  = !empty($form_state['xrnote_note_nid']) ? (int) $form_state['xrnote_note_nid'] : 0;

  $commands = array();

  if (!$nid || $uuid === '') {
    // Temporary debug: prove what the server received.
    $dbg = array(
      'uuid' => $uuid,
      'note_nid' => $form_state['values']['note_nid'] ?? null,
      'new_body_len' => isset($form_state['values']['new_body']) ? strlen((string) $form_state['values']['new_body']) : null,
    );
    $commands[] = ajax_command_alert(t('Nothing to insert. Debug: @d', array('@d' => print_r($dbg, TRUE))));
    return array('#type' => 'ajax', '#commands' => $commands);
  }

$payload = array('uuid' => $uuid, 'note_nid' => $nid);

$commands[] = ajax_command_invoke('body', 'trigger', array(
  'xrnote-insert',
  array($payload),   // <-- IMPORTANT: wrap it
));

  return array('#type' => 'ajax', '#commands' => $commands);
}

/* ^^ NEW STUFF ^^ */

function xrnote_ajax_sidebar($node) {
  $op = isset($_POST['op']) ? $_POST['op'] : '';
  if ($op !== 'save') return backdrop_json_output(array('status'=>'error','msg'=>'Bad op'));
  $uuid = $_POST['uuid'];
  $note_nid = (int) $_POST['note_nid'];
  $selector = json_decode($_POST['selector'], TRUE) ?: array();

  xrnote_save_anchor($node->nid, $note_nid, $uuid, $selector);
  return backdrop_json_output(array('status'=>'ok'));
}

// Document detector: has 'body' and is not the note bundle.
function xrnote_is_document_node($node) {
  return is_object($node)
    && !empty($node->type)
    && $node->type !== 'xrnote'
    && isset($node->body) && is_array($node->body);
}

/**
 * Implements hook_tinymce_external_plugins().
 */
function xrnote_tinymce_external_plugins($format) {
  $module_url = base_path() . backdrop_get_path('module', 'xrnote');

  return array(
    'xrnote' => array(
      // TinyMCE will load this file when the plugin is enabled in the profile.
      'plugin_path' => $module_url . '/js/plugins/xrnote/plugin.js',

      // This is what makes the button show up in the TinyMCE builder UI.
      'buttons' => array(
        'xrnote' => array(
          'tooltip' => 'Insert XRNote',
          'required_tags' => array('span'),
          // Optional: provide an icon name if you ship one (see below).
          // 'icon' => 'xrnote',
        ),
      ),

      // Optional if you ship a custom icon file:
      // 'icons' => array('xrnote' => 'xrnote.svg'),
    ),
  );
}
