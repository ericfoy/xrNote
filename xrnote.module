<?php
// Later we'll implement lazy loading...
// XRNote dev includes (eager load).
require_once __DIR__ . '/includes/xrnote.anchor.inc';
require_once __DIR__ . '/includes/xrnote.render.inc';
//require_once __DIR__ . '/includes/xrnote.pages.inc';   // modal + AJAX handlers
//require_once __DIR__ . '/xrnote.theme.inc';            // theme functions (if any)

/*
Caution: The function should not be used in a global context (e.g., at the very 
top of your .module file, outside of any functions), as it requires Backdrop to be 
fully bootstrapped first. In a global context, you should use require_once with the 
full path if absolutely necessary. 

module_load_include('inc', 'xrnote', 'includes/xrnote.anchor');
module_load_include('inc', 'xrnote', 'includes/xrnote.render');
*/

function xrnote_permission() {
  return array(
    'create xrnotes' => array('title'=>'Create XR notes'),
    'edit own xrnotes' => array('title'=>'Edit own XR notes'),
    'edit any xrnotes' => array('title'=>'Edit any XR notes'),
    'place xrnotes' => array('title'=>'Insert XR notes into documents'),
    'configure xrnote display' => array('title'=>'Configure XRNote display modes'),
  );
}

function xrnote_menu() {
  $items['xrnote/modal/add/%node/%'] = array(
    'page callback'   => 'xrnote_modal_add',
    'page arguments'  => array(3, 4),
    'access callback' => 'xrnote_access_place',
    'access arguments'=> array(3),
    'type'            => MENU_CALLBACK,
  );

  $items['xrnote/modal/edit/%node/%'] = array(
    'page callback'   => 'xrnote_modal_edit',
    'page arguments'  => array(3, 4),
    'access callback' => 'xrnote_access_place',
    'access arguments'=> array(3),
    'type'            => MENU_CALLBACK,
  );

  $items['xrnote/anchors/%node'] = array(
    'page callback'   => 'xrnote_ajax_sidebar',
    'page arguments'  => array(2),
    'access callback' => 'xrnote_access_place',
    'access arguments'=> array(2),
    'type'            => MENU_CALLBACK,
  );

  return $items;
}

function xrnote_access_place($node) {
  return user_access('place xrnotes') && node_access('update', $node);
}

/**
 * Attach TinyMCE plugin and the live sidebar on node edit of target types.
 * Replace 'xrnote' with your actual content type that has "Main Text".
 */
function xrnote_form_alter(&$form, &$form_state, $form_id) {
  if (($form_id !== 'node_form' && strpos($form_id, '_node_form') === FALSE) || empty($form['#node'])) 
    return;

  $node = $form['#node'];
  if (!xrnote_is_document_node($node)) 
    return;

  // Attach editor UI, sidebar, assets.
  $form['xrnote_sidebar'] = array(
    '#type'=>'markup', 
    '#markup'=>'<div id="xrnote-sidebar" class="xrnote-sidebar"></div>', 
    '#weight'=>-10
  );
  
  $form['#attached']['library'][] = array('system', 'ui.dialog');
  //$form['#attached']['js'][]  = backdrop_get_path('module','xrnote') . '/js/plugins/xrnote/plugin.js';
  $form['#attached']['js'][]  = backdrop_get_path('module','xrnote') . '/js/xrnote.sidebar.js';
  $form['#attached']['css'][] = backdrop_get_path('module','xrnote') . '/css/xrnote.admin.css';
  $form['#attached']['js'][] = array('type'=>'setting','data'=>array('xrnote'=>array('nid'=>$node->nid,'basePath'=>base_path())));
}

function xrnote_node_update($node) {
  if (!xrnote_is_document_node($node)) return;
  xrnote_reanchor_node($node);
}

function xrnote_node_view($node, $view_mode, $langcode) {
  if (!xrnote_is_document_node($node)) return;
  $lang = field_language('node', $node, 'body');
  if (!empty($node->content['body'][$lang][0]['#markup'])) {
    $html = $node->content['body'][$lang][0]['#markup'];
    $node->content['body'][$lang][0]['#markup'] = xrnote_inline_replace($html);
  }
}
/* OLD STUFF
function xrnote_modal_add($parent_node, $uuid) {
  // Build a tiny form: create new xrnote or select existing “stock” note.
  $form = array();
  $form['note_nid'] = array(
    '#type' => 'entity_autocomplete',
    '#title' => t('Select existing XRNote'),
    '#target_type' => 'node',
    '#selection_settings' => array('target_bundles' => array('xrnote' => 'xrnote')),
    '#required' => FALSE,
  );
  $form['new_body'] = array('#type'=>'textarea', '#title'=>t('Or create new'), '#rows'=>4);
  $form['lists'] = array(
    '#type' => 'entityreference_autocomplete',
    '#title' => t('Lists'),
    '#target_type' => 'taxonomy_term',
    '#selection_settings' => array('target_bundles'=>array('xrnote_lists'=>'xrnote_lists')),
    '#tags' => TRUE,
  );
  $form['actions']['submit'] = array('#type'=>'submit', '#value'=>t('Insert'));
  $form['#submit'][] = 'xrnote_modal_add_submit';
  $form['#xr_uuid'] = $uuid;
  return backdrop_render($form); // Return HTML for jQuery UI Dialog.
}

function xrnote_modal_add_submit($form, &$form_state) {
  $nid = !empty($form_state['values']['note_nid']) ? (int)$form_state['values']['note_nid'] : 0;
  if (!$nid && !empty($form_state['values']['new_body'])) {
    $n = (object) array(
      'type' => 'xrnote',
      'title' => 'XRNote ' . REQUEST_TIME,
      'status' => 1,
      'language' => LANGUAGE_NONE,
    );
    node_object_prepare($n);
    $lang = LANGUAGE_NONE;
    $n->field_xr_body[$lang][0]['value'] = $form_state['values']['new_body'];
    $nid = node_save($n) ? $n->nid : 0;
  }
  // Emit a tiny script that dispatches the insert event and closes the dialog.
  $uuid = check_plain($form['#xr_uuid']);
  $nid_js = (int) $nid;
  $script = '<script>(function(){var ev=new CustomEvent("xrnote-insert",{detail:{uuid:"'.$uuid.'",note_nid:'.$nid_js.'}});window.dispatchEvent(ev);jQuery(".ui-dialog-content").dialog("close");}());</script>';
  print $script;
  backdrop_exit();
}
*/
/* NEW STUFF */
function xrnote_modal_add($parent_node, $uuid) {
  return backdrop_get_form('xrnote_modal_add_form', $parent_node, $uuid);
}

function xrnote_modal_add_form($form, &$form_state, $parent_node, $uuid) {
  $form['#prefix'] = '<div id="xrnote-modal-add-wrapper">';
  $form['#suffix'] = '</div>';

  $form['parent_nid'] = array(
    '#type' => 'value',
    '#value' => (int) $parent_node->nid,
  );
  $form['xr_uuid'] = array(
    '#type' => 'value',
    '#value' => $uuid,
  );

  $form['note_nid'] = array(
    '#type' => 'entity_autocomplete',
    '#title' => t('Select existing XRNote'),
    '#target_type' => 'node',
    '#selection_settings' => array('target_bundles' => array('xrnote' => 'xrnote')),
    '#required' => FALSE,
  );

  $form['new_body'] = array(
    '#type' => 'textarea',
    '#title' => t('Or create new'),
    '#rows' => 6,
  );

  $form['actions'] = array('#type' => 'actions');
  $form['actions']['insert'] = array(
    '#type' => 'submit',
    '#value' => t('Insert'),
    '#ajax' => array(
      'callback' => 'xrnote_modal_add_form_ajax',
      'wrapper' => 'xrnote-modal-add-wrapper',
    ),
  );

  return $form;
}

function xrnote_modal_add_form_submit($form, &$form_state) {
  $nid = !empty($form_state['values']['note_nid']) ? (int) $form_state['values']['note_nid'] : 0;

  if (!$nid) {
  $body = trim((string) $form_state['values']['new_body']);
  if ($body !== '') {

    // Backdrop: create a real Node entity (not stdClass).
    $n = entity_create('node', array(
      'type'     => 'xrnote',
      'title'    => 'XRNote ' . REQUEST_TIME,
      'status'   => 1,
      'langcode' => LANGUAGE_NONE,
    ));  // :contentReference[oaicite:1]{index=1}

    // Fill your field(s).
    $lang = LANGUAGE_NONE;
    $n->field_xr_body[$lang][0]['value'] = $body;

    // Save (either is fine).
    $n->save();      // preferred in Backdrop  :contentReference[oaicite:2]{index=2}
    // node_save($n); // wrapper also exists; requires Node $node :contentReference[oaicite:3]{index=3}

    $nid = !empty($n->nid) ? (int) $n->nid : 0;
    }
  }
  // Stash for the AJAX callback.
  $form_state['storage']['xrnote_result'] = array(
    'uuid' => (string) $form_state['values']['xr_uuid'],
    'note_nid' => $nid,
  );
}

function xrnote_modal_add_form_ajax($form, &$form_state) {
  $res  = isset($form_state['storage']['xrnote_result']) ? $form_state['storage']['xrnote_result'] : array();
  $uuid = isset($res['uuid']) ? $res['uuid'] : '';
  $nid  = !empty($res['note_nid']) ? (int) $res['note_nid'] : 0;

  $commands = array();

  if (!$nid || $uuid === '') {
    $commands[] = ajax_command_alert(t('Nothing to insert. Select an existing note or enter text to create one.'));
    return array('#type' => 'ajax', '#commands' => $commands);
  }

  $payload = array('uuid' => $uuid, 'note_nid' => $nid);

  $js =
    'jQuery("body").trigger("xrnote-insert", ' . json_encode($payload) . ');' .
    'if (window.jQuery && window.jQuery.fn && window.jQuery.fn.dialog) {' .
      'window.jQuery(".xrnote-dialog").dialog("close");' .
    '}';

  $commands[] = ajax_command_script($js);

  return array('#type' => 'ajax', '#commands' => $commands);
}

/* ^^ NEW STUFF ^^ */

function xrnote_ajax_sidebar($node) {
  $op = isset($_POST['op']) ? $_POST['op'] : '';
  if ($op !== 'save') return backdrop_json_output(array('status'=>'error','msg'=>'Bad op'));
  $uuid = $_POST['uuid'];
  $note_nid = (int) $_POST['note_nid'];
  $selector = json_decode($_POST['selector'], TRUE) ?: array();

  xrnote_save_anchor($node->nid, $note_nid, $uuid, $selector);
  return backdrop_json_output(array('status'=>'ok'));
}

// Document detector: has 'body' and is not the note bundle.
function xrnote_is_document_node($node) {
  return is_object($node)
    && !empty($node->type)
    && $node->type !== 'xrnote'
    && isset($node->body) && is_array($node->body);
}

/**
 * Implements hook_tinymce_external_plugins().
 */
function xrnote_tinymce_external_plugins($format) {
  $module_url = base_path() . backdrop_get_path('module', 'xrnote');

  return array(
    'xrnote' => array(
      // TinyMCE will load this file when the plugin is enabled in the profile.
      'plugin_path' => $module_url . '/js/plugins/xrnote/plugin.js',

      // This is what makes the button show up in the TinyMCE builder UI.
      'buttons' => array(
        'xrnote' => array(
          'tooltip' => 'Insert XRNote',
          'required_tags' => array('span'),
          // Optional: provide an icon name if you ship one (see below).
          // 'icon' => 'xrnote',
        ),
      ),

      // Optional if you ship a custom icon file:
      // 'icons' => array('xrnote' => 'xrnote.svg'),
    ),
  );
}
