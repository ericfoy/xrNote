<?php
// Later we'll implement lazy loading...
// XRNote dev includes (eager load).
//require_once __DIR__ . '/includes/xrnote.anchor.inc';
//require_once __DIR__ . '/includes/xrnote.render.inc';
//require_once __DIR__ . '/includes/xrnote.pages.inc';   // modal + AJAX handlers
//require_once __DIR__ . '/xrnote.theme.inc';            // theme functions (if any)
//require_once __DIR__ . '/lib/diff_match_patch.php';    // minimal DMP wrapper

function xrnote_permission() {
  return array(
    'create xrnotes' => array('title'=>'Create XR notes'),
    'edit own xrnotes' => array('title'=>'Edit own XR notes'),
    'edit any xrnotes' => array('title'=>'Edit any XR notes'),
    'place xrnotes' => array('title'=>'Insert XR notes into documents'),
    'configure xrnote display' => array('title'=>'Configure XRNote display modes'),
  );
}

function xrnote_menu() {
  $items['xrnote/modal/add/%node/%'] = array(
    'page callback'   => 'xrnote_modal_add',
    'page arguments'  => array(2, 3), // parent node, uuid
    'access callback' => 'xrnote_access_place',
    'access arguments'=> array(2),
    'type'            => MENU_CALLBACK,
  );
  $items['xrnote/modal/edit/%node/%'] = array(
    'page callback'   => 'xrnote_modal_edit',
    'page arguments'  => array(2, 3), // parent node, uuid
    'access callback' => 'xrnote_access_place',
    'access arguments'=> array(2),
    'type'            => MENU_CALLBACK,
  );
  $items['xrnote/anchors/%node'] = array(
    'page callback'   => 'xrnote_ajax_sidebar',
    'page arguments'  => array(2),
    'access callback' => 'xrnote_access_place',
    'access arguments'=> array(2),
    'type'            => MENU_CALLBACK,
  );
  return $items;
}

function xrnote_access_place($node) {
  return user_access('place xrnotes') && node_access('update', $node);
}

/**
 * Attach TinyMCE plugin and the live sidebar on node edit of target types.
 * Replace 'xrnote' with your actual content type that has "Main Text".
 */
function xrnote_form_alter(&$form, &$form_state, $form_id) {
  if (($form_id !== 'node_form' && strpos($form_id, '_node_form') === FALSE) || empty($form['#node'])) 
    return;

  $node = $form['#node'];
  if (!xrnote_is_document_node($node)) 
    return;

  // Attach editor UI, sidebar, assets.
  $form['xrnote_sidebar'] = array(
    '#type'=>'markup', 
    '#markup'=>'<div id="xrnote-sidebar" class="xrnote-sidebar"></div>', 
    '#weight'=>-10
  );
  
  $form['#attached']['library'][] = array('system', 'ui.dialog');
  $form['#attached']['js'][]  = backdrop_get_path('module','xrnote') . '/js/xrnote.tinymce.js';
  $form['#attached']['js'][]  = backdrop_get_path('module','xrnote') . '/js/xrnote.sidebar.js';
  $form['#attached']['css'][] = backdrop_get_path('module','xrnote') . '/css/xrnote.admin.css';
  $form['#attached']['js'][] = array('type'=>'setting','data'=>array('xrnote'=>array('nid'=>$node->nid,'basePath'=>base_path())));
}

function xrnote_node_update($node) {
  if (!xrnote_is_document_node($node)) return;
  xrnote_reanchor_node($node);
}
function xrnote_node_view($node, $view_mode, $langcode) {
  if (!xrnote_is_document_node($node)) return;
  xrnote_attach_view_assets($node, $view_mode);
}

function xrnote_modal_add($parent_node, $uuid) {
  // Build a tiny form: create new xrnote or select existing “stock” note.
  $form = array();
  $form['note_nid'] = array(
    '#type' => 'entity_autocomplete',
    '#title' => t('Select existing XRNote'),
    '#target_type' => 'node',
    '#selection_settings' => array('target_bundles' => array('xrnote' => 'xrnote')),
    '#required' => FALSE,
  );
  $form['new_body'] = array('#type'=>'textarea', '#title'=>t('Or create new'), '#rows'=>4);
  $form['lists'] = array(
    '#type' => 'entityreference_autocomplete',
    '#title' => t('Lists'),
    '#target_type' => 'taxonomy_term',
    '#selection_settings' => array('target_bundles'=>array('xrnote_lists'=>'xrnote_lists')),
    '#tags' => TRUE,
  );
  $form['actions']['submit'] = array('#type'=>'submit', '#value'=>t('Insert'));
  $form['#submit'][] = 'xrnote_modal_add_submit';
  $form['#xr_uuid'] = $uuid;
  return backdrop_render($form); // Return HTML for jQuery UI Dialog.
}

function xrnote_modal_add_submit($form, &$form_state) {
  $nid = !empty($form_state['values']['note_nid']) ? (int)$form_state['values']['note_nid'] : 0;
  if (!$nid && !empty($form_state['values']['new_body'])) {
    $n = (object) array(
      'type' => 'xrnote',
      'title' => 'XRNote ' . REQUEST_TIME,
      'status' => 1,
      'language' => LANGUAGE_NONE,
    );
    node_object_prepare($n);
    $lang = LANGUAGE_NONE;
    $n->field_xr_body[$lang][0]['value'] = $form_state['values']['new_body'];
    $nid = node_save($n) ? $n->nid : 0;
  }
  // Emit a tiny script that dispatches the insert event and closes the dialog.
  $uuid = check_plain($form['#xr_uuid']);
  $nid_js = (int) $nid;
  $script = '<script>(function(){window.dispatchEvent(new CustomEvent("xrnote-insert",{detail:{uuid:"'.$uuid.'",note_nid:'.$nid_js.'}})); window.jQuery(".xrnote-dialog").dialog("close");})();</script>';
  print $script;
  backdrop_exit();
}

function xrnote_ajax_sidebar($node) {
  $op = isset($_POST['op']) ? $_POST['op'] : '';
  if ($op !== 'save') return backdrop_json_output(array('status'=>'error','msg'=>'Bad op'));
  $uuid = $_POST['uuid'];
  $note_nid = (int) $_POST['note_nid'];
  $selector = json_decode($_POST['selector'], TRUE) ?: array();

  xrnote_save_anchor($node->nid, $note_nid, $uuid, $selector);
  return backdrop_json_output(array('status'=>'ok'));
}

// Document detector: has 'body' and is not the note bundle.
function xrnote_is_document_node($node) {
  return is_object($node)
    && !empty($node->type)
    && $node->type !== 'xrnote'
    && isset($node->body) && is_array($node->body);
}

/* Deleteme, prolly
function _xrnote_current_body($node) {
  $fn = 'body'; // the main text field for note attach-to capability
  if (empty($node->{$fn})) return NULL;
  $lang = field_language('node', $node, $fn);
  if (!$lang) $lang = LANGUAGE_NONE;
  return isset($node->{$fn}[$lang][0]['value']) ? $node->{$fn}[$lang][0]['value'] : NULL;
}
*/
